services:
  # Mock OAuth2 Server (Python Flask) - FOR TESTING ONLY
  # This is a simple OAuth server to test TokenRelay's OAuth functionality
  # In production, configure TokenRelay to use your real OAuth server (Keycloak, Auth0, Okta, etc.)
  oauth-server:
    build:
      context: ./mock-oauth-server
      dockerfile: Dockerfile
    container_name: "${OAUTH_SERVER_CONTAINER:-tokenrelay-oauth-server}"
    ports:
      - "${OAUTH_SERVER_EXTERNAL_PORT:-8080}:8080"
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8080/health')"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    restart: unless-stopped

  # TokenRelay - Built locally from source
  tokenrelay-local:
    build:
      context: ..
      dockerfile: docker/Dockerfile
      args:
        VERSION: ${TOKENRELAY_VERSION:-1.0.0-docker}
        BUILD_DATE: ${BUILD_DATE:-unknown}
    container_name: "${CONTAINER_NAME:-tokenrelay-local}"
    ports:
      - "${TOKENRELAY_EXTERNAL_PORT:-5163}:${TOKENRELAY_PORT:-80}"
    environment:
      - ASPNETCORE_ENVIRONMENT=${ASPNETCORE_ENVIRONMENT:-Production}
      - ASPNETCORE_URLS=http://+:${TOKENRELAY_PORT:-80}
      - ConfigPath=/app/tokenrelay.json
      - TOKENRELAY_CONFIG_MODE=${TOKENRELAY_CONFIG_MODE:-file}
      - TOKENRELAY_CONFIG_JSON=${TOKENRELAY_CONFIG_JSON:-}
      - TOKENRELAY_VERSION=${TOKENRELAY_VERSION:-1.0.0-docker}
      # New Relic APM Configuration (optional - disabled by default)
      # Set NEW_RELIC_ENABLED=true to enable APM monitoring
      - NEW_RELIC_ENABLED=${NEW_RELIC_ENABLED:-false}
      - NEW_RELIC_LICENSE_KEY=${NEW_RELIC_LICENSE_KEY:-}
      - NEW_RELIC_APP_NAME=${NEW_RELIC_APP_NAME:-TokenRelay}
      # Infinite Tracing (requires trace observer setup in New Relic UI)
      # Get endpoint from: one.newrelic.com > Infinite Tracing settings
      - NEW_RELIC_INFINITE_TRACING_TRACE_OBSERVER_HOST=${NEW_RELIC_TRACE_OBSERVER_HOST:-}
      # Distributed tracing for cross-service trace correlation
      - NEW_RELIC_DISTRIBUTED_TRACING_ENABLED=true
      # New Relic agent log level (debug, info, warn, error)
      - NEW_RELIC_LOG_LEVEL=${NEW_RELIC_LOG_LEVEL:-info}
    volumes:
      # Mount configuration file (when using file-based config)
      # WARNING: Create your own tokenrelay.json with proper credentials!
      # You can copy tokenrelay.template.json as a starting point
      - ${TOKENRELAY_CONFIG_PATH:-./config/tokenrelay.json}:/app/tokenrelay.json:ro
      # Mount upload directory
      - ${TOKENRELAY_UPLOADS_PATH:-./uploads}:/app/uploads
      # Mount logs directory
      - ${TOKENRELAY_LOGS_PATH:-./logs}:/app/logs
      # Optional: Mount custom certificates directory
      # Place your .crt files in this directory to have them loaded at startup
      - ${TOKENRELAY_CERTS_PATH:-./certs}:/home/site/certs:ro
      # Optional: Mount custom New Relic configuration
      - ${NEWRELIC_CONFIG_PATH:-./newrelic.config}:/usr/local/newrelic-dotnet-agent/newrelic.config:ro
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:${TOKENRELAY_PORT:-80}/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # TokenRelay - Pulled from Docker Hub
  # NOTE: New Relic APM requires Docker Hub image version with New Relic agent installed.
  # Images built after this change will include New Relic support.
  tokenrelay-hub:
    image: infigosoftware/tokenrelay:${TOKENRELAY_HUB_VERSION:-latest}
    container_name: "${CONTAINER_NAME_HUB:-tokenrelay-hub}"
    ports:
      - "${TOKENRELAY_HUB_EXTERNAL_PORT:-5164}:${TOKENRELAY_PORT:-80}"
    environment:
      - ASPNETCORE_ENVIRONMENT=${ASPNETCORE_ENVIRONMENT:-Production}
      - ASPNETCORE_URLS=http://+:${TOKENRELAY_PORT:-80}
      - ConfigPath=/app/tokenrelay.json
      - TOKENRELAY_CONFIG_MODE=${TOKENRELAY_CONFIG_MODE:-file}
      - TOKENRELAY_CONFIG_JSON=${TOKENRELAY_CONFIG_JSON:-}
      - TOKENRELAY_VERSION=${TOKENRELAY_HUB_VERSION:-latest}
      # New Relic APM Configuration (optional - disabled by default)
      # Set NEW_RELIC_ENABLED=true to enable APM monitoring
      - NEW_RELIC_ENABLED=${NEW_RELIC_ENABLED:-false}
      - NEW_RELIC_LICENSE_KEY=${NEW_RELIC_LICENSE_KEY:-}
      - NEW_RELIC_APP_NAME=${NEW_RELIC_APP_NAME:-TokenRelay}
      # Infinite Tracing (requires trace observer setup in New Relic UI)
      # Get endpoint from: one.newrelic.com > Infinite Tracing settings
      - NEW_RELIC_INFINITE_TRACING_TRACE_OBSERVER_HOST=${NEW_RELIC_TRACE_OBSERVER_HOST:-}
      # Distributed tracing for cross-service trace correlation
      - NEW_RELIC_DISTRIBUTED_TRACING_ENABLED=true
      # New Relic agent log level (debug, info, warn, error)
      - NEW_RELIC_LOG_LEVEL=${NEW_RELIC_LOG_LEVEL:-info}
    volumes:
      # Mount configuration file (when using file-based config)
      - ${TOKENRELAY_CONFIG_PATH:-./config/tokenrelay.json}:/app/tokenrelay.json:ro
      # Mount upload directory for Docker Hub version
      - ${TOKENRELAY_HUB_UPLOADS_PATH:-./uploads-hub}:/app/uploads
      # Mount logs directory for Docker Hub version
      - ${TOKENRELAY_HUB_LOGS_PATH:-./logs-hub}:/app/logs
      # Optional: Mount custom certificates directory
      - ${TOKENRELAY_CERTS_PATH:-./certs}:/home/site/certs:ro
      # Optional: Mount custom New Relic configuration
      - ${NEWRELIC_CONFIG_PATH:-./newrelic.config}:/usr/local/newrelic-dotnet-agent/newrelic.config:ro
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:${TOKENRELAY_PORT:-80}/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Optional: Nginx reverse proxy for production
  nginx:
    image: nginx:alpine
    container_name: "${NGINX_CONTAINER_NAME:-tokenrelay-nginx}"
    ports:
      - "${NGINX_EXTERNAL_PORT:-8080}:80"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - tokenrelay-local
      - tokenrelay-hub
    restart: unless-stopped
    profiles:
      - "with-nginx"

networks:
  default:
    name: tokenrelay-network
