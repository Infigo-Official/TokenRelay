<?xml version="1.0"?>
<!-- New Relic .NET Agent Configuration for TokenRelay

     This configuration file provides default settings for New Relic APM.
     Most settings can be overridden via environment variables.

     Required Environment Variables:
       - NEW_RELIC_LICENSE_KEY: Your New Relic license key
       - NEW_RELIC_APP_NAME: Application name (default: TokenRelay)

     Optional Environment Variables for Infinite Tracing:
       - NEW_RELIC_INFINITE_TRACING_TRACE_OBSERVER_HOST: Trace observer endpoint
         (e.g., your-observer.aws-us-east-1.infinitetracing.com)

     For more configuration options, see:
     https://docs.newrelic.com/docs/apm/agents/net-agent/configuration/net-agent-configuration/
-->
<configuration xmlns="urn:newrelic-config" agentEnabled="true">

  <!-- License key is set via NEW_RELIC_LICENSE_KEY environment variable -->
  <service licenseKey="REPLACE_WITH_LICENSE_KEY_OR_USE_ENV_VAR" />

  <application>
    <!-- App name is set via NEW_RELIC_APP_NAME environment variable -->
    <name>TokenRelay</name>
  </application>

  <!-- Logging configuration for the agent itself -->
  <log level="info" directory="/app/logs" fileName="newrelic_agent.log" />

  <!--
    Distributed Tracing Configuration

    TokenRelay acts as a proxy and may receive requests with distributed tracing
    headers (traceparent/tracestate) from upstream services. The agent will:
    1. Accept incoming W3C Trace Context headers
    2. Continue the trace context through TokenRelay processing
    3. Propagate trace headers to downstream services
  -->
  <distributedTracing enabled="true">
    <!-- Accept both W3C Trace Context and New Relic headers for maximum compatibility -->
    <excludeNewrelicHeader>false</excludeNewrelicHeader>
  </distributedTracing>

  <!--
    Infinite Tracing Configuration

    Infinite Tracing uses tail-based sampling to capture 100% of traces.
    Set the trace observer host via NEW_RELIC_INFINITE_TRACING_TRACE_OBSERVER_HOST
    environment variable.

    To set up a trace observer:
    1. Go to one.newrelic.com > All capabilities > Infinite Tracing settings
    2. Create a new trace observer for your region
    3. Copy the endpoint (without https://) to the environment variable
  -->
  <infiniteTracing>
    <!-- Host is set via NEW_RELIC_INFINITE_TRACING_TRACE_OBSERVER_HOST env var -->
    <trace_observer host="" />
  </infiniteTracing>

  <!-- Span events provide detailed timing information for distributed traces -->
  <spanEvents enabled="true">
    <attributes enabled="true">
      <!-- TokenRelay-specific attributes (non-sensitive) -->
      <include>request.headers.TOKEN-RELAY-TARGET</include>
      <include>request.headers.TOKEN-RELAY-ORIGIN</include>
      <include>request.headers.TOKEN-RELAY-CHAIN</include>
      <include>request.headers.TOKEN-RELAY-PROXIED</include>
      <!-- Common request headers (non-sensitive) -->
      <include>request.headers.Content-Type</include>
      <include>request.headers.Accept</include>
      <include>request.headers.User-Agent</include>
      <!-- Correlation headers for request tracing -->
      <include>request.headers.X-Request-ID</include>
      <include>request.headers.X-Correlation-ID</include>
      <include>request.headers.X-Trace-ID</include>
      <!-- W3C Trace Context (useful for debugging distributed traces) -->
      <include>request.headers.traceparent</include>
      <include>request.headers.tracestate</include>
      <!-- HTTP details -->
      <include>http.url</include>
      <include>http.method</include>
      <include>http.statusCode</include>
      <include>response.status</include>
      <include>request.uri</include>
      <!-- Custom attributes we add programmatically (tokenrelay.*) -->
      <include>tokenrelay.*</include>

      <!-- Exclude sensitive headers from traces -->
      <exclude>request.headers.TOKEN-RELAY-AUTH</exclude>
      <exclude>request.headers.Authorization</exclude>
      <exclude>request.headers.Cookie</exclude>
      <exclude>request.headers.Set-Cookie</exclude>
      <exclude>request.headers.X-API-Key</exclude>
      <exclude>request.headers.API-Key</exclude>
      <exclude>request.headers.X-Auth-Token</exclude>
      <exclude>request.headers.X-Access-Token</exclude>
      <exclude>request.headers.X-Refresh-Token</exclude>
      <exclude>request.headers.WWW-Authenticate</exclude>
      <exclude>request.headers.Proxy-Authorization</exclude>
      <exclude>request.headers.Proxy-Authenticate</exclude>
      <!-- Exclude sensitive query parameters -->
      <exclude>request.parameters.password</exclude>
      <exclude>request.parameters.token</exclude>
      <exclude>request.parameters.secret</exclude>
      <exclude>request.parameters.key</exclude>
      <exclude>request.parameters.api_key</exclude>
      <exclude>request.parameters.apikey</exclude>
      <exclude>request.parameters.access_token</exclude>
      <exclude>request.parameters.refresh_token</exclude>
      <exclude>request.parameters.client_secret</exclude>
      <exclude>request.parameters.auth</exclude>
      <exclude>request.parameters.code</exclude>
    </attributes>
  </spanEvents>

  <!-- Transaction tracer for detailed transaction analysis -->
  <transactionTracer enabled="true"
                     transactionThreshold="apdex_f"
                     recordSql="obfuscated"
                     explainEnabled="true"
                     explainThreshold="500"
                     stackTraceThreshold="500">
    <attributes enabled="true">
      <!-- Include custom attributes -->
      <include>tokenrelay.*</include>
      <!-- Exclude sensitive data -->
      <exclude>request.headers.TOKEN-RELAY-AUTH</exclude>
      <exclude>request.headers.Authorization</exclude>
      <exclude>request.headers.Cookie</exclude>
      <exclude>request.headers.Set-Cookie</exclude>
      <exclude>request.headers.X-API-Key</exclude>
      <exclude>request.headers.API-Key</exclude>
      <exclude>request.headers.X-Auth-Token</exclude>
      <exclude>request.headers.X-Access-Token</exclude>
      <exclude>request.headers.X-Refresh-Token</exclude>
      <exclude>request.headers.WWW-Authenticate</exclude>
      <exclude>request.headers.Proxy-Authorization</exclude>
      <exclude>request.headers.Proxy-Authenticate</exclude>
      <exclude>request.parameters.password</exclude>
      <exclude>request.parameters.token</exclude>
      <exclude>request.parameters.secret</exclude>
      <exclude>request.parameters.key</exclude>
      <exclude>request.parameters.api_key</exclude>
      <exclude>request.parameters.access_token</exclude>
      <exclude>request.parameters.refresh_token</exclude>
      <exclude>request.parameters.client_secret</exclude>
      <exclude>request.parameters.code</exclude>
    </attributes>
  </transactionTracer>

  <!-- Error collector for exception tracking -->
  <errorCollector enabled="true">
    <ignoreStatusCodes>
      <!-- Don't report client errors as errors -->
      <code>400</code>
      <code>401</code>
      <code>403</code>
      <code>404</code>
    </ignoreStatusCodes>
    <attributes enabled="true">
      <!-- Include custom error attributes -->
      <include>tokenrelay.*</include>
      <!-- Exclude sensitive data from error traces -->
      <exclude>request.headers.TOKEN-RELAY-AUTH</exclude>
      <exclude>request.headers.Authorization</exclude>
      <exclude>request.headers.Cookie</exclude>
      <exclude>request.headers.Set-Cookie</exclude>
      <exclude>request.headers.X-API-Key</exclude>
      <exclude>request.headers.API-Key</exclude>
      <exclude>request.headers.X-Auth-Token</exclude>
      <exclude>request.headers.X-Access-Token</exclude>
      <exclude>request.headers.X-Refresh-Token</exclude>
      <exclude>request.headers.WWW-Authenticate</exclude>
      <exclude>request.headers.Proxy-Authorization</exclude>
      <exclude>request.headers.Proxy-Authenticate</exclude>
      <exclude>request.parameters.password</exclude>
      <exclude>request.parameters.token</exclude>
      <exclude>request.parameters.secret</exclude>
      <exclude>request.parameters.key</exclude>
      <exclude>request.parameters.api_key</exclude>
      <exclude>request.parameters.access_token</exclude>
      <exclude>request.parameters.refresh_token</exclude>
      <exclude>request.parameters.client_secret</exclude>
      <exclude>request.parameters.code</exclude>
    </attributes>
  </errorCollector>

  <!-- Browser monitoring disabled - this is an API service -->
  <browserMonitoring autoInstrument="false" />

  <!--
    Cross Application Tracing (deprecated, use distributed tracing instead)
    Disabled in favor of distributed tracing
  -->
  <crossApplicationTracer enabled="false" />

  <!-- Transaction events for analytics -->
  <transactionEvents enabled="true">
    <attributes enabled="true">
      <!-- Include custom attributes for analytics -->
      <include>tokenrelay.*</include>
      <!-- Exclude sensitive data -->
      <exclude>request.headers.TOKEN-RELAY-AUTH</exclude>
      <exclude>request.headers.Authorization</exclude>
      <exclude>request.headers.Cookie</exclude>
      <exclude>request.headers.Set-Cookie</exclude>
      <exclude>request.headers.X-API-Key</exclude>
      <exclude>request.headers.API-Key</exclude>
      <exclude>request.headers.X-Auth-Token</exclude>
      <exclude>request.headers.X-Access-Token</exclude>
      <exclude>request.headers.X-Refresh-Token</exclude>
      <exclude>request.headers.WWW-Authenticate</exclude>
      <exclude>request.headers.Proxy-Authorization</exclude>
      <exclude>request.headers.Proxy-Authenticate</exclude>
      <exclude>request.parameters.password</exclude>
      <exclude>request.parameters.token</exclude>
      <exclude>request.parameters.secret</exclude>
      <exclude>request.parameters.key</exclude>
      <exclude>request.parameters.api_key</exclude>
      <exclude>request.parameters.access_token</exclude>
      <exclude>request.parameters.refresh_token</exclude>
      <exclude>request.parameters.client_secret</exclude>
      <exclude>request.parameters.code</exclude>
    </attributes>
  </transactionEvents>

  <!-- Custom events (for application-specific telemetry) -->
  <customEvents enabled="true" />

  <!--
    Instrumentation settings
    The agent auto-instruments ASP.NET Core controllers and HttpClient calls
  -->
  <instrumentation>
    <applications>
      <application name="TokenRelay.dll" />
    </applications>
  </instrumentation>

  <!--
    Application Logging
    Forward .NET logs to New Relic for correlation with traces
  -->
  <applicationLogging enabled="true">
    <forwarding enabled="true" maxSamplesStored="10000" />
    <metrics enabled="true" />
    <localDecorating enabled="false" />
  </applicationLogging>

</configuration>
